

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mini App Telegram</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <style>
    /* ... (TODOS TUS ESTILOS PERMANECEN IGUALES) ... */
  </style>
</head>
<body>
  <div class="container">
    <div class="message" id="statusMessage">
      Haz clic en el bot√≥n para unirte al canal
    </div>
    <button class="telegram-btn blue-btn" id="mainButton">
      Clic aqu√≠ para continuar üöÄ
    </button>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const button = document.getElementById('mainButton');
      const message = document.getElementById('statusMessage');
      
      const isTelegramWebApp = window.Telegram && window.Telegram.WebApp;
      if (isTelegramWebApp) {
        Telegram.WebApp.ready();
        console.log('‚úÖ Mini App de Telegram inicializada');
      }
      
      function setupFirstStep() {
        message.textContent = "Haz clic en el bot√≥n para unirte al canal";
        button.className = "telegram-btn blue-btn";
        button.innerHTML = "Clic aqu√≠ para continuar üöÄ";
        button.disabled = false;
        button.onclick = openTelegramLink;
      }
      
      // --- FUNCI√ìN ACTUALIZADA CON OPCI√ìN 1 + OPCI√ìN 3 ---
      function openTelegramLink() {
        button.innerHTML = "Redirigiendo...";
        button.disabled = true;
        
        // --- OPCI√ìN 1: CONTROL MANUAL (T√ö DECIDES) ---
        const miEnlacePrincipal = 'https://t.me/+W9PjhmA7r6Q1Y2Mx'; // 1. Tu enlace aqu√≠
        const miNumeroDeVersion = 'v1'; // 2. ¬°INCREMENTA ESTE N√öMERO (v2, v3...)!
        // -----------------------------------------------
        
        // --- OPCI√ìN 3: PAR√ÅMETRO DIN√ÅMICO (EVITA CACH√â EN CADA CLIC) ---
        // Se a√±ade un timestamp √∫nico (milisegundos actuales) como par√°metro adicional
        const timestampUnico = '&t=' + new Date().getTime();
        // -----------------------------------------------------------------
        
        // ENLACE FINAL: Combina tu versi√≥n + timestamp √∫nico para m√°ximo control
        const telegramLink = miEnlacePrincipal + '?ref=' + miNumeroDeVersion + timestampUnico;
        // Ejemplo resultante: https://t.me/+W9PjhmA7r6Q1Y2Mx?ref=v1&t=1749020400000
        
        if (isTelegramWebApp && Telegram.WebApp.openLink) {
          Telegram.WebApp.openLink(telegramLink);
        } else {
          window.open(telegramLink, '_blank');
        }
        
        setupReturnDetection();
      }
      
      function setupReturnDetection() {
        window.addEventListener('focus', handleUserReturn);
        document.addEventListener('visibilitychange', function() {
          if (!document.hidden) handleUserReturn();
        });
        setTimeout(handleUserReturn, 3000);
      }
      
      function handleUserReturn() {
        window.removeEventListener('focus', handleUserReturn);
        setupSecondStep();
      }
      
      function setupSecondStep() {
        message.textContent = "¬°Gracias por enviar tu solicitud! Ser√° aprobada lo m√°s pronto posible.";
        button.className = "telegram-btn red-btn";
        button.innerHTML = "Clic aqu√≠ para salir";
        button.disabled = false;
        button.onclick = closeMiniApp;
      }
      
      function closeMiniApp() {
        if (isTelegramWebApp && Telegram.WebApp.close) {
          Telegram.WebApp.close();
        } else {
          button.innerHTML = "¬°App cerrada!";
          button.disabled = true;
          message.textContent = "Si estuvieras en Telegram, la Mini App se cerrar√≠a.";
        }
      }
      
      setupFirstStep();
      
      // FUNCI√ìN CORREGIDA (error de sintaxis arreglado)
      function adjustButtonSize() {
        const viewportHeight = window.innerHeight;
        if (viewportHeight < 700) {
          button.style.height = Math.max(110, viewportHeight * 0.18) + 'px';
        }
      }
      
      adjustButtonSize();
      window.addEventListener('resize', adjustButtonSize);
    });
  </script>
</body>
</html>
